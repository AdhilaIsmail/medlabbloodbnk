{% load static %}
<html lang="en">


<!-- add-patient24:06-->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'mainuser/img/logocp.png' %}">
    <title>Medlab Blood Bank</title>
    <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/font-awesome.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/select2.min.css' %}">
    {% comment %} <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/dataTables.bootstrap4.min.css' %}"> {% endcomment %}
    <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/bootstrap-datetimepicker.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mainuser/css/style.css' %}">
    <script src="https://kit.fontawesome.com/044329719f.js" crossorigin="anonymous"></script>
    <style>
        body {
            background-image: url("{% static 'img/9.jpg' %}"); /* Replace 'background.jpg' with your image file name */
            background-repeat: no-repeat;
            background-size: cover; /* You can adjust this property to control how the image is displayed */
        }
        .sidebar {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            top: 50px;
            width: 230px;
            z-index: 1039;
            background-color:#d1bebc;
            bottom: 0;
            margin-top: 0px;
            position: fixed;
            left: 0;
            transition: all 0.2s ease-in-out;
        }
        .sidebar.opened {
            -webkit-transition: all 0.4s ease;
            -moz-transition: all 0.4s ease;
            transition: all 0.4s ease;
        }
        .sidebar-inner {
            height: 100%;
            transition: all 0.2s ease-in-out 0s;
        }
        .sidebar-menu ul {
            font-size: 14px;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        .sidebar-menu li a {
            color: white;
            display: block;
            font-size: 13px;
            height: auto;
            padding: 0 20px;
        }
        .sidebar-menu li a:hover {
            color: #802020;
        }
        .sidebar-menu li.active a {
            color: #802020;
            background-color: #f3f3f3;
        }
        .menu-title {
            color: #333;
            font-size: 15px;
            font-weight: 500;
            padding: 12px 20px;
        }
        .menu-title > i {
            float: right;
            line-height: 40px;
        }
        .sidebar-menu li.menu-title a {
            color: #009efb;
            display: inline-block;
            float: right;
            padding: 0;
        }
        .sidebar-menu li.menu-title a.btn {
            color: #fff;
            display: block;
            float: none;
            font-size: 15px;
            line-height: inherit;
            margin-bottom: 15px;
        }
        .sidebar-menu ul ul a.active {
            color: #009efb;
            text-decoration: underline;
        }
        .header {
            /* ... other styles ... */
            background-color: #ffffff; /* Change this to the desired color */
            /* ... other styles ... */
            
        }
        
    </style>   

</head>

<body>
    <div class="main-wrapper">
        <div class="header" style="background-color:white;height:60px;"> 
			<div class="header-left">
				<a href="{% url 'adminindex' %}" class="logo" style="color: black;">
					<img src="{% static 'mainuser/img/logocopy.png' %}" width="75" height="40" alt="" style="margin-left:15px"> <span style="color: maroon;font-size: 20px;margin-top:10px; margin-left:-10px;white-space: nowrap;">Medlab Blood Bank</span>
				</a>
			</div>
			<a id="toggle_btn" href="javascript:void(0);" style="color:#d69c98;margin-top:20px;margin-left:10px;"><i class="fa fa-bars"></i></a>
            <a id="mobile_btn" class="mobile_btn float-left" href="#sidebar"><i class="fa fa-bars"></i></a>
            <ul class="nav user-menu float-right">
                
                <li class="nav-item dropdown has-arrow">
                    <a href="#" class="dropdown-toggle nav-link user-link" data-toggle="dropdown"style="color:maroon">
                        
						<span style="color:maroon;">Admin</span>
                    </a>
					<div class="dropdown-menu">
						<a class="dropdown-item" href="{% url 'profile1' %}" style="color:maroon;">My Profile</a>
						<a class="dropdown-item" href="{% url 'editprofile' %}" style="color:maroon;">Edit Profile</a>
						
						<a class="dropdown-item" href="{% url 'loggout' %}" style="color:maroon;">Logout</a>
					</div>
                </li>
                
            </ul> 
            <div class="dropdown mobile-user-menu float-right">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="{% url 'profile1' %}" style="color:maroon;">My Profile</a>
                    <a class="dropdown-item" href="{% url 'editprofile' %}" style="color:maroon;">Edit Profile</a>
                  
                    <a class="dropdown-item" href="{% url 'loggout' %}" style="color:maroon;">Logout</a>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-inner slimscroll">
                <div id="sidebar-menu" class="sidebar-menu">
                    <ul>
                        <li class="menu-title">Main</li>
                        <li>
                            <a href="{% url 'adminindex' %}"><i class="fa fa-dashboard"></i> <span>Dashboard</span></a>
                        </li>
						<li>
                            <a href="{% url 'donors_list' %}"><i class="fa fa-users"></i> <span>Donors</span></a>
                        </li>
                        <li>
                            <a href="{% url 'registereddonortable' %}"><i class="fa fa-registered"></i> <span>Registered Donors</span></a>
                        </li>
                        <li class="active">
                            <a href="{% url 'registeredhospitaltable' %}"><i class="fa fa-hospital-o"></i> <span>Add Hospitals</span></a>
                        </li>
                        <li>
                            <a href="{% url 'registeredstafftable' %}"><i class="fa fa-address-book-o"></i> <span>Add Staffs</span></a>
                        </li>
                        <!-- <li>
                            <a href="doctors.html"><i class="fa fa-calendar-check-o"></i> <span>Staffs</span></a>
                        </li> -->
                        <li>
                            <a href="{% url 'departments' %}"><i class="fa fa-hospital-o"></i> <span>Blood Bank Camps</span></a>
                        </li>
                       
                        <li>
                            <a href="{% url 'blood_request_list' %}"><i class="fa fa-list-alt"></i> <span>View Requests</span></a>
                        </li>
						<li>
                            <a href="{% url 'view_uploaded_files' %}"><i class="fa fa-list-alt"></i> <span>View Lab Results</span></a>
                        </li>
                        <li>
                            <a href="{% url 'blood_inventory' %}"><i class="fa fa-tint"></i> <span>Blood Inventory</span></a>
                        </li>
                        <li>
                            <a href="{% url 'laboratory' %}"><i class="fa-solid fa-vials"></i><span>Laboratory</span></a>
                        </li>
						<li class="submenu">
							<a href="#"><i class="fa fa-user"></i> <span>Staffs </span> <span class="menu-arrow"></span></a>
							<ul style="display: none;">
								<li><a href="{% url 'registeredstafftable' %}">Blood Bank Staff</a></li>
                                <li><a href="{% url 'registeredstafftablelab' %}">Laboratory Staff</a></li>
								<li><a href="{% url 'listgps' %}">Add grampanchayats</a></li>
								<li><a href="{% url 'assign_staff' %}">Assign Staffs</a></li>
							</ul>
						</li> 
                    </ul>
                </div>
            </div>
        </div>
        <div class="page-wrapper">
            <div class="content">
                <div class="row">
                    <div class="col-lg-8 offset-lg-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="page-title">Assigning Staffs To grampanchayat</h4>
                            <!-- Add the button for viewing registered hospitals -->
                       
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8 offset-lg-2">
                        <form action="{% url 'assign_staff' %}" method="POST">
                            {% csrf_token %}
                                <!-- Display form errors -->
                            {% if form.errors %}
                                <div class="alert alert-danger">
                                    <strong>Error!</strong> Please correct the following errors:
                                    <ul>
                                        {% for field, error_list in form.errors.items %}
                                            {% for error in error_list %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label>Staff Name <span class="text-danger">*</span></label>
                                        <select class="form-control" name="staffName" required>
                                            {% for staff in staff_members %}
                                                <option value="{{ staff.id }}">{{ staff.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                        
                                <!-- Dropdown Boxes for grampanchayats -->
                                {% for i in "12345" %}
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label>Grampanchayat {{ i }} <span class="text-danger">*</span></label>
                                        <select class="form-control" id="grampanchayat{{ i }}" name="grampanchayat{{ i }}" required>
                                            <!-- Options for grampanchayat{{ i }} will be dynamically generated using JavaScript -->
                                        </select>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        
                            <div class="m-t-20 text-center">
                                <button class="btn btn-primary submit-btn">Update Hospital</button>
                            </div>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>
        
    </div>
    <div class="sidebar-overlay" data-reff=""></div>
   
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="{% static 'mainuser/js/popper.min.js' %}"></script>
    <script src="{% static 'mainuser/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'mainuser/js/jquery.slimscroll.js' %}"></script>
    <script src="{% static 'mainuser/js/select2.min.js' %}"></script>
    <script src="{% static 'mainuser/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'mainuser/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'mainuser/js/moment.min.js' %}"></script>
    <script src="{% static 'mainuser/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'mainuser/js/app.js' %}"></script>
    <!-- ... Your existing HTML ... -->
    <script>
        $(document).ready(function () {
            console.log('Document ready!');
            
            var grampanchayat1 = $('#grampanchayat1');
            var grampanchayat2 = $('#grampanchayat2');
            var grampanchayat3 = $('#grampanchayat3');
            var grampanchayat4 = $('#grampanchayat4');
            var grampanchayat5 = $('#grampanchayat5');
        
            var allGrampanchayats; // To store all Grampanchayats data
        
            // Fetch the data from the server
            $.ajax({
                url: '/api/grampanchayats/',  // Replace with the actual URL endpoint for Grampanchayats
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    allGrampanchayats = data;
        
                    // Populate dropdown options
                    populateDropdown(grampanchayat1, allGrampanchayats);
                    populateDropdown(grampanchayat2, allGrampanchayats);
                    populateDropdown(grampanchayat3, allGrampanchayats);
                    populateDropdown(grampanchayat4, allGrampanchayats);
                    populateDropdown(grampanchayat5, allGrampanchayats);
        
                    // Event listener for grampanchayat1 change
                    grampanchayat1.on('change', function () {
                        var selectedOption = $('option:selected', this);
        
                        // Call the validation function
                        checkIfOptionExists(selectedOption, grampanchayat1);
                        checkIfDuplicateSelected(selectedOption, grampanchayat1);
        
                        // Filter data for other dropdowns based on the selected district
                        var selectedDistrict = selectedOption.data('district');
                        var filteredData = allGrampanchayats.filter(function (item) {
                            return item.name_of_grampanchayat === selectedOption.text();
                        });
        
                        // Populate other dropdowns with filtered data
                       // populateDropdown(grampanchayat2, filteredData);
                       // populateDropdown(grampanchayat3, filteredData);
                       // populateDropdown(grampanchayat4, filteredData);
                        //populateDropdown(grampanchayat5, filteredData); 
                    });
                    
                    grampanchayat2.on('change', function () {
                        var selectedOption = $('option:selected', this);
                        checkIfOptionExists(selectedOption, grampanchayat2);
                        checkIfDuplicateSelected(selectedOption, grampanchayat2); // Add this line
                        // Additional logic if needed
                    });
    
                   
                    grampanchayat3.on('change', function () {
                        var selectedOption = $('option:selected', this);
                        checkIfOptionExists(selectedOption, grampanchayat3);
                        checkIfDuplicateSelected(selectedOption, grampanchayat3); // Add this line
                        // Additional logic if needed
                    });
        
                    grampanchayat4.on('change', function () {
                        var selectedOption = $('option:selected', this);
                        checkIfOptionExists(selectedOption, grampanchayat4);
                        checkIfDuplicateSelected(selectedOption, grampanchayat4); // Add this line
                        // Additional logic if needed
                    });
        
                    grampanchayat5.on('change', function () {
                        var selectedOption = $('option:selected', this);
                        checkIfOptionExists(selectedOption, grampanchayat5);
                        checkIfDuplicateSelected(selectedOption, grampanchayat5); // Add this line
                        // Additional logic if needed
                    });
                },
                error: function (error) {
                    console.error('Error fetching Grampanchayat data:', error);
                }
            });
        
            // Function to populate dropdown options
            function populateDropdown(dropdown, data) {
                dropdown.empty(); // Clear existing options
                data.forEach(function (item) {
                    dropdown.append($('<option>', {
                        value: item.id,
                        text: item.name_of_grampanchayat,
                    }));
                });
            }
        
            // Function to check if the selected option already exists in the database
            function checkIfOptionExists(selectedOption, dropdown) {
                // Make an AJAX request to the server for validation
                $.ajax({
                    url: '{% url "validate_assign_grampanchayat" %}',
                    type: 'POST',
                    data: {
                        grampanchayatName: selectedOption.text(),
                        additionalField: $('#additionalField').val() // Update with the actual ID or selector of your additional field
                    },
                    dataType: 'json',
                    success: function (response) {
                        if (response.exists) {
                            // Option or associated data already exists, show an error message
                            showErrorMessage(dropdown, 'Error: This Grampanchayat or associated data already assigned.');
                        } else {
                            hideErrorMessage(dropdown);
                        }
                    },
                    error: function () {
                        console.error('Error validating AssignGrampanchayat.');
                    }
                });
            }
            
            function checkIfDuplicateSelected(selectedOption, dropdown) {
                console.log('Checking for duplicates:', selectedOption.val(), dropdown.attr('id'));

                // Get the index (1-5) from the dropdown's ID
                var index = dropdown.attr('id').replace('grampanchayat', '');
            
                // Collect selected options from all dropdowns
                var selectedOptions = [];
                for (var i = 1; i <= 5; i++) {
                    if (i != index) {
                        selectedOptions.push($('#grampanchayat' + i).val());
                    }
                }
            
                // Check if the selected option exists in other dropdowns
                if (selectedOptions.includes(selectedOption.val())) {
                    // Option already exists in another field, show an error message
                    showErrorMessage(dropdown, 'Error: This Grampanchayat is already selected in another field.');
                } else {
                    hideErrorMessage(dropdown);
                }
            }
            
            
            // Function to show an error message next to the dropdown
            function showErrorMessage(dropdown, message) {
                var errorMessageSpan = dropdown.next('.error-message');
                if (!errorMessageSpan.length) {
                    errorMessageSpan = $('<span class="error-message"></span>');
                    dropdown.after(errorMessageSpan);
                }
                errorMessageSpan.text(message);
            }

            // Function to hide the error message next to the dropdown
            function hideErrorMessage(dropdown) {
                dropdown.next('.error-message').remove();
            }

            $('form').submit(function (event) {
                // Check if there's any error message
                if ($('.error-message').length > 0) {
                    event.preventDefault(); // Prevent form submission
                    alert('Please fix the errors before submitting.'); // You can replace this with a more user-friendly message
                }
            });
        });
            
    
    </script>    
   

    {% comment %} <script src="{% static 'mainuser/js/jquery-3.2.1.min.js' %}"></script> {% endcomment %}
	
</body>


</html>
